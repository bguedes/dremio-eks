= dremio installation on EKS

'''

Version : 1.0.0 + date : 2024/06/18 +

'''

image::https://university.dremio.com/asset-v1:dremio+DCE3+2019+type@asset+block@gnarly-aws-eks.png[]


== Introduction

This github repository show a simple step by step EKS ckuster creation and a Dremio installation on it.

== Pre-requisites

. Laptop with a Linux, Windows or Macbook.
. A modern browser.
. Wifi Internet connection.
. https://www.docker.com/products/docker-desktop/[Docker Destop] or https://podman-desktop.io/[Podman Desktop] installed

== Step 1: Setup docker image

We are going to use a docker image https://hub.docker.com/r/alpine/k8s[alpine/k8s].
This image brings all needed tools for creating the EKS cluster and install Dremio on it :

____
https://github.com/helm/helm[helm] +
https://kubernetes.io/docs/tasks/tools/install-kubectl/[kubectl] +
https://github.com/aws/aws-cli[awscli]
____

[,console]
----
docker pull alpine/k8s:1.27.13
docker run -i -t alpine/k8s:1.27.13 bash
----

[,console]
----
podman pull alpine/k8s:1.27.13
podman run -i -t alpine/k8s:1.27.13 bash
----


== Step 2: AWS configure

{blank}

=== Configuring specific roles

{blank}

You need to create 2 roles with these policy configuration.
For the first role, here it is the configuration :

{blank}

image::images/Role-policy1.png[]

{blank}

Create a customer managed policy like this :

{blank}

image::images/Role-policy3.png[]

{blank}

[,json]
----
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "s3:PutObject",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:DeleteObject"
            ],
            "Resource": [
                "arn:aws:s3:::bj-s3",
                "arn:aws:s3:::bj-s3/*"
            ]
        },
        {
            "Effect": "Allow",
            "Action": [
                "s3:ListALLMyBuckets",
                "s3:GetBucketLocation"
            ],
            "Resource": "*"
        }
    ]
}
----

For the second role, here it is the configuration :

{blank}

image::images/Role-policy2.png[]

{blank}

=== Configuring AWS 

{blank}

On the docker image bash, launch :

[,console]
----
aws configure
----
{blank}


please fill up the values according your aws credentials :

____
AWS Access Key ID [None]: +
AWS Secret Access Key [None]: +
Default region name [None]: +
Default output format [None]:
____

Verify that parameters has been taken in account :

[,console]
----
aws sts get-caller-identity
{
    "Account": "XXXXXXXXXXX",
    "UserId": "XXXXXXXXX",
    "Arn": "arn:aws:iam::622194627903:user/XXXXXXXX"
}
----

== Step 3: Create EKS cluster

We are going to use AWS console home UI.

{blank}

image::images/create-eks1.png[]

{blank}

{blank}

image::images/create-eks2.png[]

{blank}

{blank}

image::images/create-eks3.png[]

{blank}

{blank}

image::images/create-eks4.png[]

{blank}

{blank}

image::images/create-eks5.png[]

{blank}

{blank}

image::images/create-eks6.png[]

{blank}

{blank}

image::images/create-eks7.png[]

{blank}

[,console]
----
eksctl utils associate-iam-oidc-provider --region=us-east-1 --cluster=ucn-eks-cluster --approve
----


[,console]
----
aws eks update-kubeconfig --region us-east-1 --name ucn-eks-cluster
----


[,console]
----
eksctl create iamserviceaccount \
 --name ebs-csi-controller-sa \
 --namespace kube-system \
 --cluster ucn-eks-cluster \
 --attach-policy-arn arn:aws:iam::aws:policy/service-role/AmazonEBSCSIDriverPolicy \
 --approve \
 --role-only \
 --role-name AmazonEKS_EBS_CSI_DriverRole
----
